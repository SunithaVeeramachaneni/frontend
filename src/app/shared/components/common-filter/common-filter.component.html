<span class="custom-mat-form-field-gray-color">
  <mat-form-field appearance="outline" class="search-bar">
    <mat-icon matPrefix class="search-icon">search</mat-icon>
    <input
      matInput
      [placeholder]="'searchWorkOrders' | translate"
      [(ngModel)]="searchValue"
      (ngModelChange)="debouncedSearchOrder($event)"
      class="common-filter-search"
      autocomplete="off"
    />
    <img
      src="../../../../assets/maintenance-icons/filterIcon.svg"
      matSuffix
      cdkOverlayOrigin
      #trigger="cdkOverlayOrigin"
      (click)="isPopoverOpen = !isPopoverOpen"
      class="common-filter-icon"
    />
  </mat-form-field>
</span>

<ng-template
  cdkConnectedOverlay
  cdkConnectedOverlayPanelClass="custom-popover"
  cdkConnectedOverlayBackdropClass="cdk-overlay-transparent-backdrop"
  [cdkConnectedOverlayHasBackdrop]="true"
  [cdkConnectedOverlayOpen]="isPopoverOpen"
  [cdkConnectedOverlayOrigin]="trigger"
  cdkConnectedOverlayWidth="400px"
  (backdropClick)="isPopoverOpen = true"
>
  <div
    class="filter-modal"
    *ngIf="
      this.title === 'Spare Parts Control Center' ||
      this.title === 'Maintenance Control Center'
    "
  >
    <div class="m-b-10 filter-header">
      <span class="filter-modal-heading">{{ 'filter' | translate }}</span>
      <button class="filter-modal-cancel" (click)="isPopoverOpen = false">
        <img src="../../../../assets/img/svg/cancel-icon.svg" />
      </button>
    </div>
    <form #form="ngForm">
      <div class="filter-form-fields custom-mat-form-select">
        <mat-form-field appearance="outline" class="mat-field">
          <mat-label>{{ 'showOverdue' | translate }}</mat-label>
          <mat-select name="showOverdue" [(ngModel)]="showOverdue">
            <mat-option
              *ngFor="let showdue of showOverdueList"
              [value]="showdue"
            >
              {{ showdue }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline" class="mat-field">
          <mat-label>{{ 'priority' | translate }}</mat-label>
          <mat-select name="priority" multiple [(ngModel)]="priority">
            <mat-option
              *ngFor="let prioritizedItem of priorityList"
              [value]="prioritizedItem"
              >{{ prioritizedItem }}</mat-option
            >
          </mat-select>
        </mat-form-field>

        <mat-form-field
          *ngIf="kitStatusList"
          appearance="outline"
          class="mat-field"
        >
          <mat-label>{{ 'kittingStatus' | translate }}</mat-label>
          <mat-select name="kitStatus" multiple [(ngModel)]="kitStatus">
            <mat-option *ngFor="let kit of kitStatusList" [value]="kit">{{
              kit
            }}</mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field
          *ngIf="workCenterList"
          appearance="outline"
          class="mat-field"
        >
          <mat-label>{{ 'workCenter' | translate }}</mat-label>
          <mat-select
            name="workCenter"
            multiple
            [(ngModel)]="workCenter"
            (selectionChange)="this.onCenterChange($event)"
          >
            <mat-option
              *ngFor="let workCenterItem of workCenterList"
              [value]="workCenterItem"
              >{{ workCenterItem.workCenterKey }}</mat-option
            >
          </mat-select>
        </mat-form-field>
        <mat-form-field
          appearance="outline"
          class="mat-field"
          *ngIf="workCenter.length !== 0"
        >
          <mat-label>{{ 'assignee' | translate }}</mat-label>
          <mat-select name="assign" multiple [(ngModel)]="assign">
            <mat-option
              *ngFor="let assigned of displayedAssigneeList"
              [value]="assigned"
            >
              <img
                [hidden]="!getImageSrc(assigned.image)"
                [attr.src]="getImageSrc(assigned.image)"
                alt=""
                style="
                  width: 36px;
                  height: 36px;
                  border-radius: 50%;
                  margin-right: 5px;
                "
              />
              {{ assigned.personName }}
            </mat-option>
          </mat-select>
        </mat-form-field>
      </div>
      <button
        class="apply-filters-btn"
        (click)="isPopoverOpen = false; searchFilter()"
      >
        {{ 'apply' | translate }}
      </button>
      <button
        (click)="form.reset(); clearFilter(); searchFilter()"
        class="reset-filters-btn"
      >
        {{ 'reset' | translate }}
      </button>
    </form>
  </div>

  <div class="filter-report-modal" *ngIf="this.title === undefined">
    <div class="m-b-10 filter-header">
      <span class="filter-modal-heading">{{ 'filter' | translate }}</span>
      <button class="filter-modal-cancel" (click)="isPopoverOpen = false">
        <img src="../../../../assets/img/svg/cancel-icon.svg" />
      </button>
    </div>
    <form>
      <div
        class="filter-form-fields custom-mat-form-select"
        style="max-height: 350px"
      >
        <mat-form-field appearance="outline" class="width-100">
          <mat-icon matPrefix>search</mat-icon>
          <input
            type="text"
            placeholder="Add Filter"
            matInput
            [matAutocomplete]="autoCompleteFilter"
          />
          <mat-autocomplete #autoCompleteFilter="matAutocomplete">
            <mat-option *ngFor="let col of dropdownReportColumns; let index = index">
              <div (click)="addFilter(col, index)">
                {{ col.displayName }}
              </div>
            </mat-option>
          </mat-autocomplete>
        </mat-form-field>
        <form [formGroup]="filtersForm" (ngSubmit)="saveFilter()">
          <mat-list
            role="list"
            *ngFor="let filterForm of filters.controls; let i = index"
            formArrayName="filters"
          >
            <mat-list-item role="listitem">
              <ng-container [formGroup]="filterForm">
                <mat-form-field
                  appearance="outline"
                  cdkOverlayOrigin
                  #trigger="cdkOverlayOrigin"
                  (click)="openFilterModal(filterForm.value, i)"
                  class="width-100"
                  *ngIf="filterForm.value.filterType !== 'daterange'"
                >
                  <mat-label>{{ filterForm.value.displayName }}</mat-label>
                  <input
                    type="text"
                    placeholder="{{ filterForm.value.displayName }}"
                    value="{{ filterForm.value.displayText }}"
                    matInput
                  />
                  <mat-icon
                    matSuffix
                    (click)="
                      deleteFilteredField(
                        filterForm.value,
                        i,
                        operatorType[i],
                        inputValue[i]
                      )
                    "
                    class="delete-icon"
                  >
                    delete
                  </mat-icon>
                </mat-form-field>
              </ng-container>
              <ng-container [formGroup]="filterForm">
                <mat-form-field
                  appearance="outline"
                  cdkOverlayOrigin
                  #trigger="cdkOverlayOrigin"
                  (click)="openFilterModal(filterForm.value, i)"
                  class="width-100"
                  *ngIf="filterForm.value.filterType === 'daterange'"
                >
                  <mat-label>{{ filterForm.value.displayName }}</mat-label>
                  <input
                    type="text"
                    placeholder="{{ filterForm.value.displayName }}"
                    value="{{ filterForm.value.displayText }}"
                    matInput
                  />
                  <mat-icon
                    matSuffix
                    (click)="deleteFilteredField(filterForm.value, i)"
                    class="delete-icon"
                  >
                    delete
                  </mat-icon>
                </mat-form-field>
              </ng-container>
            </mat-list-item>
            <ng-template
              cdkConnectedOverlay
              [cdkConnectedOverlayHasBackdrop]="true"
              cdkConnectedOverlayPanelClass="custom-popover"
              cdkConnectedOverlayBackdropClass="cdk-overlay-transparent-backdrop"
              cdkConnectedOverlayWidth="400px"
              [cdkConnectedOverlayOpen]="isfilterTooltipOpen[i]"
              [cdkConnectedOverlayOrigin]="trigger"
              (backdropClick)="isfilterTooltipOpen[i] = false"
            >
              <form
                [formGroup]="filterForm"
                (ngSubmit)="onSave()"
                class="filter-input-modal"
              >
                <div class="m-b-10">
                  <span class="filter-modal-heading">
                    Filter by {{ filterForm.value.displayName }}
                  </span>
                  <button
                    class="filter-modal-cancel"
                    type="button"
                    (click)="isfilterTooltipOpen[i] = false"
                  >
                    <img src="../../../../assets/img/svg/cancel-icon.svg" />
                  </button>
                </div>
                <div>
                  <div
                    *ngIf="
                      filterForm.value.filterType !== 'multi' &&
                      filterForm.value.filterType !== 'single' &&
                      filterForm.value.filterType !== 'daterange'
                    "
                  >
                    <p class="operator-text">Operator</p>
                    <select
                      formControlName="operator"
                      name="operatorType"
                      class="operator-dropdown"
                    >
                      <option
                        *ngFor="let option of filteredOptionsByType"
                        value="{{ option }}"
                      >
                        {{ option }}
                      </option>
                    </select>
                  </div>

                  <div *ngIf="filterForm.value.filterType === 'string'">
                    <mat-form-field appearance="outline" class="width-100">
                      <input
                        type="text"
                        matInput
                        name="stringOperand"
                        formControlName="operand"
                      />
                    </mat-form-field>
                  </div>

                  <div *ngIf="filterForm.value.filterType === 'number'">
                    <mat-form-field appearance="outline" class="width-100">
                      <input
                        type="number"
                        name="inputValue"
                        matInput
                        formControlName="operand"
                      />
                    </mat-form-field>
                  </div>

                  <div *ngIf="filterForm.value.filterType === 'daterange'">
                    <mat-form-field appearance="outline" class="width-100">
                      <mat-select name="inputValue" formControlName="operator">
                        <mat-option
                          *ngFor="let val of this.filteredOptionsByType"
                          [value]="val"
                          >{{ val }}</mat-option
                        >
                      </mat-select>
                    </mat-form-field>

                    <div *ngIf="filterForm.value.operator === 'custom'">
                      <button
                        (focus)="rangePicker.open()"
                        class="select-date-range-btn"
                      >
                        {{ customBtnText }}
                      </button>
                      <mat-form-field
                        appearance="fill"
                        class="example-form-field"
                        style="visibility: hidden; width: 0"
                      >
                        <mat-date-range-input
                          [rangePicker]="rangePicker"
                          formGroupName="operand"
                          class="datepicker"
                        >
                          <input
                            type="button"
                            matStartDate
                            name="startDate"
                            formControlName="startDate"
                          />
                          <input
                            type="button"
                            matEndDate
                            name="endDate"
                            formControlName="endDate"
                          />
                        </mat-date-range-input>
                        <mat-date-range-picker #rangePicker>
                          <mat-date-range-picker-actions>
                            <button mat-button matDateRangePickerCancel>
                              {{ 'cancel' | translate }}
                            </button>
                            <button
                              mat-raised-button
                              type="submit"
                              color="primary"
                              matDateRangePickerApply
                            >
                              {{ 'apply' | translate }}
                            </button>
                          </mat-date-range-picker-actions>
                        </mat-date-range-picker>
                      </mat-form-field>
                    </div>
                  </div>

                  <div *ngIf="filterForm.value.filterType === 'multi'">
                    <mat-form-field appearance="outline" class="width-100">
                      <mat-label>{{ filterForm.value.displayName }}</mat-label>
                      <mat-select
                        multiple
                        name="inputValue"
                        formControlName="operand"
                      >
                        <mat-option
                          *ngFor="
                            let val of this.filteredOptionsByType[
                              filterForm.value.name
                            ]
                          "
                          [value]="val"
                          >{{ val }}</mat-option
                        >
                      </mat-select>
                    </mat-form-field>
                  </div>

                  <div *ngIf="filterForm.value.filterType === 'single'">
                    <mat-form-field appearance="outline" class="width-100">
                      <mat-label>{{ filterForm.value.displayName }}</mat-label>
                      <mat-select name="inputValue" formControlName="operand">
                        <mat-option
                          name="singleOperand"
                          *ngFor="
                            let val of this.filteredOptionsByType[
                              filterForm.value.name
                            ]
                          "
                          [value]="val"
                          >{{ val }}</mat-option
                        >
                      </mat-select>
                    </mat-form-field>
                  </div>

                  <button
                    class="save-btn"
                    mat-raised-button
                    type="submit"
                    [disabled]="filterForm.invalid"
                  >
                    Save
                  </button>
                </div>
              </form>
            </ng-template>
          </mat-list>
        </form>
      </div>
      <button
        class="btn apply-filters-btn"
        (click)="applyFilters()"
        type="button"
      >
        {{ 'apply' | translate }}
      </button>
      <button class="btn reset-filters-btn" (click)="clearFilters()">
        {{ 'reset' | translate }}
      </button>
    </form>
  </div>
</ng-template>
