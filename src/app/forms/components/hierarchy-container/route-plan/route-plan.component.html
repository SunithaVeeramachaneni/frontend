<ng-template #tmplNode let-node="node">
  <div class="node-item" [attr.data-id]="node.id" [attr.id]="'node-' + node.id">
    <div
      *ngIf="!node.isDeletedInRoutePlan"
      class="parentNode node"
      [ngClass]="{ active: selectedNode.id === node.id }"
      (click)="setSelectedNode(node)"
    >
      <div class="left">
        <div class="dis-flex">
          <img
            *ngIf="hierarchyMode !== 'asset_hierarchy'"
            cdkDragHandle
            src="assets/rdf-forms-icons/six-dots.svg"
            alt="six-dots"
            class="question-six-dots"
          />
          <div class="nodeContent" class="nodeContent">
            <img [src]="node.image" />
            <div class="description">
              <span class="title">{{ node.name }}</span>
              <span class="subTitle">
                {{
                  'nodeSubTitle'
                    | translate
                      : { nodeType: node.type | titlecase, nodeId: node.nodeId }
                }}
              </span>
            </div>
          </div>
        </div>
        <div
          *ngIf="node.hasChildren && node.children && node.children.length"
          class="childrenHead"
          [ngClass]="{ white: selectedNode.id === node.id }"
        >
          <span
            class="expandCollapseBtn"
            (click)="node.isExpanded = !node.isExpanded"
            ><mat-icon [ngClass]="{ 'rotate-270': !node.isExpanded }"
              >expand_circle_down</mat-icon
            ></span
          >
          <span>
            {{
              'nodeChildrenHead'
                | translate
                  : {
                      assetsCount: assetHierarchyUtil.getAssetCountByNode(node),
                      tasksCount: getTotalTasksCountByNode(node)
                    }
            }}
          </span>
        </div>
      </div>
      <div class="right">
        <span> {{ getTasksCountByNodeId(node.id) }} </span>
        <span
          [matMenuTriggerFor]="hierarchyMenu"
          #hierarchyMenuTrigger="matMenuTrigger"
          class="more-icon"
          aria-label="More Options"
        >
          <mat-icon>more_horiz</mat-icon>
        </span>
        <mat-menu #hierarchyMenu="matMenu" xPosition="before">
          <button
            mat-menu-item
            cdkOverlayOrigin
            #trigger="cdkOverlayOrigin"
            (click)="toggleShowHierarchyPopover(node)"
          >
            <span translate="showHierarchy"></span>
          </button>
          <ng-template
            cdkConnectedOverlay
            [cdkConnectedOverlayOrigin]="trigger"
            [cdkConnectedOverlayOpen]="togglePopover"
          >
            <app-show-hierarchy-popup
              #showHierarchy
              class="showHierarchy"
              [nodeUid]="nodeSelectedForShowHierarchy.uid"
              (closeHierarchyOverlay)="togglePopover = $event"
            ></app-show-hierarchy-popup>
          </ng-template>
          <button mat-menu-item (click)="triggerCopyNode(node)">
            <span translate="copy"></span>
          </button>
          <button
            mat-menu-item
            class="text-red"
            (click)="onRemoveNode($event, node)"
          >
            <span translate="delete"></span>
          </button>
        </mat-menu>
      </div>
    </div>

    <div
      *ngIf="node.isExpanded && node.children.length"
      class="node-children"
      [ngClass]="{ noMarginLeft: node.isDeletedInRoutePlan }"
      cdkDropList
      [cdkDropListData]="node.children"
      [id]="node.id"
      [cdkDropListConnectedTo]="dropTargetIds"
      (cdkDropListDropped)="drop($event)"
      [cdkDropListSortingDisabled]="true"
    >
      <div
        *ngFor="let child of node.children"
        cdkDrag
        [cdkDragData]="child.id"
        (cdkDragMoved)="dragMoved($event)"
      >
        <ng-container
          *ngTemplateOutlet="tmplNode; context: { node: child }"
        ></ng-container>
      </div>
    </div>
  </div>
</ng-template>

<div
  cdkDropList
  [cdkDropListData]="hierarchy"
  [id]="'main'"
  [cdkDropListConnectedTo]="dropTargetIds"
  (cdkDropListDropped)="drop($event)"
  [cdkDropListSortingDisabled]="true"
>
  <div
    *ngFor="let node of hierarchy"
    cdkDrag
    [cdkDragData]="node.id"
    (cdkDragMoved)="dragMoved($event)"
  >
    <ng-container
      *ngTemplateOutlet="tmplNode; context: { node: node }"
    ></ng-container>
  </div>
</div>
